import Color from '../color';
import {a2hex} from '../utils';

class HexReader {
  packetData: string;
  type: number;

  constructor(data: string) {
    // Store data after length and type
    this.packetData = data.substr(6);
    this.type = parseInt(data.substr(4, 2), 16);
  }

  readByte(): number {
    // Read byte and convert to int
    let byte: number = parseInt(this.packetData.substr(0, 2), 16);

    // Chop off read data
    this.packetData = this.packetData.substr(2);

    return byte;
  }

  readColor(): Color {
    let color = {
      R: this.readByte(),
      G: this.readByte(),
      B: this.readByte()
    };

    return color;
  }

  readSByte(): number {
    let byte: number = parseInt(this.packetData.substr(0, 2), 16);

    // Chop off read data
    this.packetData = this.packetData.substr(2);

    let binaryValues: Object = {
      0: 1,
      1: 2,
      2: 4,
      3: 8,
      4: 16,
      5: 32,
      6: 64,
      7: 128
    };

    // Convert byte to signed
    let sbyte: number = 0;
    for (let i: number = 7; i >= 0; i--) {
      if ((byte & binaryValues[i]) === binaryValues[i]) {
        if (binaryValues[i] === 128) {
          sbyte = -128;
        } else {
          sbyte += binaryValues[i];
        }
      }
    }

    return sbyte;
  }

  readInt16(): number {
    // Read bytes
    let firstByte: string = this.packetData.substr(2, 2);
    let secondByte: string = this.packetData.substr(0, 2);

    // Convert to int
    let int16: number = parseInt(firstByte + secondByte, 16);

    // Chop off read data
    this.packetData = this.packetData.substr(4);

    return int16;
  }

  readInt32(): number {
    // Read bytes
    let firstByte: string = this.packetData.substr(6, 2);
    let secondByte: string = this.packetData.substr(4, 2);
    let thirdByte: string = this.packetData.substr(2, 2);
    let fourthByte: string = this.packetData.substr(0, 2);

    // Convert to int
    let int32: number = parseInt(firstByte + secondByte + thirdByte + fourthByte, 16);

    // Chop off read data
    this.packetData = this.packetData.substr(8);

    return int32;
  }

  readSingle(): number {
    // Get hex string
    let hex: string = this.packetData.substr(0, 8);

    // Use buffer to read Float
    let buf: Buffer = new Buffer(hex, 'hex');
    let single: number = buf.readFloatLE(0);

    // Chop off read data
    this.packetData = this.packetData.substr(8);

    return single;
  }

  readString(): string {
     // Read string length
      let firstByte: number = parseInt(this.packetData.substr(0, 2), 16);
      let strLength: number = firstByte;
      let digitOffset = 2;
      if (firstByte >= 128) {
          let secondByte: string = this.packetData.substr(2, 2);
          strLength = firstByte + (parseInt(secondByte, 16)-1)*128;
          digitOffset = 4;
      }

      // The used string length is in hex digits rather than characters
      strLength *= 2;

      // Read string content using length
      let strContent: string = hex2a(this.packetData.substr(digitOffset, strLength));

      // Chop off read data
      this.packetData = this.packetData.substr(digitOffset + strLength);
      return strContent;
  }
}

export default HexReader;
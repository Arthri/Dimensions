import {LogOptions} from "dimensions/configloader";
import Extension from "dimensions/extension";
import ListenServer from "dimensions/listenserver";
import Logger from "dimensions/logger";
import {requireNoCache} from "dimensions/utils";
import * as glob from "glob";
import * as path from "path";
import { Dictionary } from "dimensions/dictionary";
import ErrorHelper from 'dimensions/errorhelper';

class Extensions {
    public static folder: string = "./extensions";

    public static loadExtensions(extensionsList: Dictionary<Extension>, listenServers: { [name: string]: ListenServer }, options: LogOptions, logging: Logger, storageMap: Map<string, any>) {
        try {
            glob.sync(`${this.folder}/**/index.js`).forEach((file) => {
                const extension: Extension = new (requireNoCache(path.resolve(file), require).default)();
                const storage = storageMap.get(extension.name);
                if (extension.load && typeof storage !== "undefined") {
                    extension.load(storage);
                    storageMap.delete(extension.name);
                }

                extensionsList[extension.name] = extension;
                if (typeof extension.setListenServers === "function") {
                    extension.setListenServers(listenServers);
                }

                if (options.extensionLoad) {
                    if (options.outputToConsole) {
                        console.log(`\u001b[36m[Extension] ${extension.name} ${extension.version} loaded.\u001b[37m`);
                    }

                    logging.appendLine(`[Extension] ${extension.name} ${extension.version} loaded.`);
                }
            });
        } catch(e) {
            if (options.outputToConsole) {
                console.log("Failed to load extensions. Error: ");
                console.log(e);
            }
            
            logging.appendLine(`Failed to load extensions. Error: `);
            logging.appendLine(ErrorHelper.toMessage(e));
        }
    }
}

export default Extensions;